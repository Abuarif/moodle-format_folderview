YUI.add("moodle-format_folderview-sectiontoggle",function(e,t){function r(){r.superclass.constructor.apply(this,arguments)}var n={MAINWRAPPER:".course-content ul.folderview",ALLSECTIONS:".course-content ul.folderview li.section",SECTION:"li.section",SECTIONACTIVITIES:"ul.section",SECTIONCONTENT:".content",SECTIONSUMMARY:".summary",SECTIONNAME:".sectionname",TOGGLETARGET:".left.side .foldertoggle",EXPANDALL:"#topiclinktop .expand-sections",COLLAPSEALL:"#topiclinktop .collapse-sections"};r.NAME=t,r.ATTRS={courseid:{validator:e.Lang.isNumber},ajaxurl:{validator:e.Lang.isString},expandedsections:{value:[],validator:e.Lang.isArray},liveLog:{readOnly:!0,valueFn:function(){return M.local_mr.init_livelog({})}}},e.extend(r,e.Base,{initializer:function(){var t=e.all(n.ALLSECTIONS);this.init_aria_attributes(t);var r=e.one(n.MAINWRAPPER);r&&r.delegate("click",this.handle_section_toggle,n.TOGGLETARGET,this);var i=e.one(n.EXPANDALL);i&&i.on("click",this.handle_expand_all,this);var s=e.one(n.COLLAPSEALL);s&&s.on("click",this.handle_collapse_all,this),t.isEmpty()||t.on("drop",this.handle_drop,this)},init_aria_attributes:function(t){if(t.isEmpty())return;var r=[];t.each(function(t){var i=this.get_section_number(t);if(i===0)return;var s=t.one(n.SECTIONCONTENT),o=t.one(n.SECTIONNAME),u=t.one(n.TOGGLETARGET);if(e.Lang.isNull(u))return;if(u.local_mr_ariacontrol!==undefined)return;s.plug(M.local_mr.ariacontrolled,{ariaLabelledBy:o,ariaState:"aria-expanded",tabIndex:null,autoHideShow:!1,autoFocus:!1}),u.plug(M.local_mr.ariacontrol,{ariaControls:s}),u.local_mr_ariacontrol.on("afterToggle",function(e){this.toggle_section_classes(e.target.get("host").ancestor(n.SECTION))},this),e.Array.indexOf(this.get("expandedsections"),i)!==-1&&u.local_mr_ariacontrol.toggle_state(),r.push(s.generateID())},this),this.init_aria_attributes_toggle_all(r)},init_aria_attributes_toggle_all:function(t){var r=e.one(n.COLLAPSEALL),i=e.one(n.EXPANDALL),s=t.join(",");r&&r.setAttribute("aria-controls",s),i&&i.setAttribute("aria-controls",s)},handle_section_toggle:function(t){t.preventDefault();var r=t.target.ancestor(n.SECTION);if(r){var i=r.one(n.TOGGLETARGET);!e.Lang.isNull(i)&&i.local_mr_ariacontrol===undefined&&(this.init_aria_attributes(e.all(n.ALLSECTIONS)),i.local_mr_ariacontrol!==undefined&&i.local_mr_ariacontrol.toggle_state())}r&&r.hasClass("expanded")?this.get("liveLog").log_text(M.str.format_folderview.topicexpanded):r&&!r.hasClass("expanded")&&this.get("liveLog").log_text(M.str.format_folderview.topiccollapsed),this.save_expanded_sections()},handle_expand_all:function(t){t.preventDefault(),e.all(n.ALLSECTIONS).each(function(e){!e.hasClass("expanded")&&this.get_section_number(e)!==0&&e.one(n.TOGGLETARGET).local_mr_ariacontrol.toggle_state()},this),this.save_expanded_sections()},handle_collapse_all:function(t){t.preventDefault(),e.all(n.ALLSECTIONS).each(function(e){e.hasClass("expanded")&&this.get_section_number(e)!==0&&e.one(n.TOGGLETARGET).local_mr_ariacontrol.toggle_state()},this),this.save_expanded_sections()},handle_drop:function(e){var t=e.currentTarget;t.test(n.SECTION)||(t=t.ancestor(n.SECTION));if(t&&this.get_section_number(t)!==0)if(!t.hasClass("expanded"))t.one(n.TOGGLETARGET).local_mr_ariacontrol.toggle_state(),this.save_expanded_sections();else{var r=t.one(n.SECTIONACTIVITIES);r&&!r.hasClass("expanded")&&r.addClass("expanded")}},toggle_section_classes:function(t){if(t){var r=[t,t.one(n.SECTIONSUMMARY)],i=t.one(n.SECTIONACTIVITIES);i&&r.push(i);var s=new e.NodeList(r);t.hasClass("expanded")?s.removeClass("expanded"):s.addClass("expanded")}},save_expanded_sections:function(){var t=[];e.all("li.section.expanded").each(function(e){t.push(this.get_section_number(e))},this),e.io(this.get("ajaxurl"),{context:this,method:"POST",data:{courseid:this.get("courseid"),expandedsections:t.join(","),action:"setexpandedsections",sesskey:M.cfg.sesskey},on:{complete:function(e,t){},failure:function(e,t){}}})},get_section_number:function(e){return Number(e.get("id").replace(/section-/i,""))}}),M.format_folderview=M.format_folderview||{},M.format_folderview.SectionToggle=r,M.format_folderview.init_sectiontoggle=function(e){return new r(e)}},"@VERSION@",{requires:["base","event","io","moodle-local_mr-ariacontrol","moodle-local_mr-ariacontrolled","moodle-local_mr-livelog"]});
